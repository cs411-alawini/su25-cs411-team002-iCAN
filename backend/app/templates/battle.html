<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pokemon Battle</title>
    <style>
        body { font-family: sans-serif; background-color: #333; color: white; margin: 0; padding: 0; }
        .battle-container { max-width: 800px; margin: 20px auto; padding: 10px; border: 4px solid #ddd; background-color: #555; }
        .battle-arena { display: flex; justify-content: space-between; align-items: flex-end; height: 250px; padding: 20px; }
        .pokemon-display img { width: 150px; height: 150px; image-rendering: pixelated; /* For sharp pixel art */ }
        .info-box { border: 3px solid #ddd; border-radius: 8px; padding: 10px; background-color: #fafafa; color: #333; width: 250px; }
        .player-info-box { text-align: right; }
        .hp-bar-container { background-color: #555; border-radius: 5px; padding: 2px; border: 1px solid #333; }
        .hp-bar { background-color: #ff3b30; /* Red for low HP */ height: 10px; border-radius: 3px; transition: width 0.5s ease-in-out; }
        .hp-bar.high { background-color: #34c759; } /* Green for high HP */
        .hp-bar.medium { background-color: #ffcc00; } /* Yellow for medium HP */
        .battle-controls { border: 4px solid #ddd; margin-top: 10px; padding: 20px; min-height: 150px; }
        .action-menu, .move-menu { display: flex; flex-wrap: wrap; }
        .action-menu button, .move-menu button { flex-basis: 48%; margin: 1%; padding: 15px; font-size: 16px; cursor: pointer; }
    </style>
</head>
<body>

<div class="battle-container"
     data-user-team-id="{{ state.player_pokemon.user_team_id }}"
     data-gym-id="{{ state.opponent_pokemon.gym_id }}"
     data-player-member-id="{{ state.player_pokemon.user_team_member_id }}"
     data-opponent-member-id="{{ state.opponent_pokemon.gym_team_member_id }}">

    <div class="battle-arena">
        <div class="pokemon-display">
            <div class="info-box">
                <h3 id="opponent-name">{{ state.opponent_pokemon.pokemon_name }}</h3>
                <div class="hp-bar-container">
                    <div id="opponent-hp-bar" class="hp-bar" style="width: {{ (state.opponent_pokemon.current_hp / state.opponent_pokemon.max_hp) * 100 }}%;"></div>
                </div>
                <p><span id="opponent-hp">{{ state.opponent_pokemon.current_hp }}</span> / {{ state.opponent_pokemon.max_hp }}</p>
            </div>
            <img src="{{ state.opponent_pokemon.image_url }}" alt="{{ state.opponent_pokemon.pokemon_name }}">
        </div>

        <div class="pokemon-display">
            <img src="{{ state.player_pokemon.image_url }}" alt="{{ state.player_pokemon.pokemon_name }}">
            <div class="info-box player-info-box">
                <h3 id="player-name">{{ state.player_pokemon.pokemon_name }}</h3>
                <div class="hp-bar-container">
                    <div id="player-hp-bar" class="hp-bar" style="width: {{ (state.player_pokemon.current_hp / state.player_pokemon.max_hp) * 100 }}%;"></div>
                </div>
                <p><span id="player-hp">{{ state.player_pokemon.current_hp }}</span> / {{ state.player_pokemon.max_hp }}</p>
            </div>
        </div>
    </div>

    <div class="battle-controls">
        <div class="dialogue" id="dialogue-box">
            <p>What will {{ state.player_pokemon.pokemon_name }} do?</p>
        </div>
        <div class="action-menu" id="action-menu">
            <button onclick="showMoveMenu()">Fight</button>
            <button onclick="showTeam()">Pokémon</button>
            <button disabled>Item</button>
            <button disabled>Switch</button>
        </div>
        <div class="move-menu" id="move-menu" style="display: none;">
            {% for move in state.player_pokemon.moves %}
                {% if move.move_name %}
                    <button onclick="handleMoveClick({{ loop.index }})">
                        {{ move.move_name }}
                        (<span id="move-pp-{{ loop.index }}">{{ move.current_pp }}</span>/{{ move.max_pp }})
                    </button>
                {% endif %}
            {% endfor %}
        </div>
    </div>
</div>

<script>
    // --- UI Navigation Functions ---
    function showMoveMenu() {
        document.getElementById('action-menu').style.display = 'none';
        document.getElementById('move-menu').style.display = 'flex';
    }

    // --- API Call Functions ---

    /**
     * Fetches the user's full team data when they click the "Pokémon" button.
     */
    async function showTeam() {
        const container = document.querySelector('.battle-container');
        const user_team_id = container.dataset.userTeamId;

        const response = await fetch(`/battle/api/team/${user_team_id}`);
        const teamData = await response.json();

        // For now, we just log the data. Later, this can show a team switch screen.
        console.log("Full Team Data:", teamData);
        alert("Check the browser's developer console (F12) to see your full team data!");
    }

    /**
     * Handles the logic when a user clicks a move button.
     * This will eventually call your sp_ProcessTurn procedure.
     */
    async function handleMoveClick(moveSlot) {
        const dialogueBox = document.getElementById('dialogue-box');
        dialogueBox.innerHTML = '<p>Processing turn...</p>';

        // This is where you would build the call to your 'process_turn' API route.
        // For now, we'll just simulate a result.
        console.log(`User selected move in slot: ${moveSlot}`);
        
        // --- Placeholder for the real API call ---
        // const response = await fetch('/battle/api/turn', { method: 'POST', ... });
        // const result = await response.json();
        
        // Update UI based on the result
        dialogueBox.innerHTML = `<p>This is where the result of the move would be displayed!</p>`;
        
        // Switch back to the main action menu after the turn
        document.getElementById('action-menu').style.display = 'flex';
        document.getElementById('move-menu').style.display = 'none';
    }

</script>

</body>
</html>