<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pokemon Battle</title>
    <style>
        body { font-family: sans-serif; background-color: #333; color: white; margin: 0; padding: 0; }
        .battle-container { max-width: 800px; margin: 20px auto; padding: 10px; border: 4px solid #ddd; background-color: #555; }
        .battle-arena { display: flex; justify-content: space-between; align-items: flex-end; height: 250px; padding: 20px; }
        .pokemon-display img { width: 150px; height: 150px; image-rendering: pixelated; /* For sharp pixel art */ }
        .info-box { border: 3px solid #ddd; border-radius: 8px; padding: 10px; background-color: #fafafa; color: #333; width: 250px; }
        .player-info-box { text-align: right; }
        .hp-bar-container { background-color: #555; border-radius: 5px; padding: 2px; border: 1px solid #333; }
        .hp-bar { background-color: #ff3b30; /* Red for low HP */ height: 10px; border-radius: 3px; transition: width 0.5s ease-in-out; }
        .hp-bar.high { background-color: #34c759; } /* Green for high HP */
        .hp-bar.medium { background-color: #ffcc00; } /* Yellow for medium HP */
        .battle-controls { border: 4px solid #ddd; margin-top: 10px; padding: 20px; min-height: 150px; }
        .action-menu, .move-menu { display: flex; flex-wrap: wrap; }
        .action-menu button, .move-menu button { flex-basis: 48%; margin: 1%; padding: 15px; font-size: 16px; cursor: pointer; }
    </style>
</head>
<body>

<div class="battle-container"
     data-user-team-id="{{ state.player_pokemon.team_id }}"
     data-gym-id="{{ state.opponent_pokemon.team_id }}"
     data-player-member-id="{{ state.player_pokemon.member_id }}"
     data-opponent-member-id="{{ state.opponent_pokemon.member_id }}">

    <div class="battle-arena">
        <div class="pokemon-display">
            <div class="info-box">
                <h3 id="opponent-name">{{ state.opponent_pokemon.pokemon_name }}</h3>
                <div class="hp-bar-container">
                    <div id="opponent-hp-bar" class="hp-bar" style="width: {{ (state.opponent_pokemon.current_hp / state.opponent_pokemon.max_hp) * 100 }}%;"></div>
                </div>
                <p><span id="opponent-hp">{{ state.opponent_pokemon.current_hp }}</span> / {{ state.opponent_pokemon.max_hp }}</p>
            </div>
            <img src="{{ state.opponent_pokemon.image_url }}" alt="{{ state.opponent_pokemon.pokemon_name }}">
        </div>

        <div class="pokemon-display">
            <img src="{{ state.player_pokemon.image_url }}" alt="{{ state.player_pokemon.pokemon_name }}">
            <div class="info-box player-info-box">
                <h3 id="player-name">{{ state.player_pokemon.pokemon_name }}</h3>
                <div class="hp-bar-container">
                    <div id="player-hp-bar" class="hp-bar" style="width: {{ (state.player_pokemon.current_hp / state.player_pokemon.max_hp) * 100 }}%;"></div>
                </div>
                <p><span id="player-hp">{{ state.player_pokemon.current_hp }}</span> / {{ state.player_pokemon.max_hp }}</p>
            </div>
        </div>
    </div>

    <div class="battle-controls">
        <div class="dialogue" id="dialogue-box">
            <p>What will {{ state.player_pokemon.pokemon_name }} do?</p>
        </div>
        <div class="action-menu" id="action-menu">
            <button onclick="showMoveMenu()">Fight</button>
            <button onclick="showTeam()">Pokémon</button>
            <button disabled>Item</button>
            <button disabled>Switch</button>
        </div>
        <div class="move-menu" id="move-menu" style="display: none;">
            {% for move in state.player_pokemon.moves %}
                {% if move.move_name %}
                    <button onclick="handleMoveClick({{ loop.index }})">
                        {{ move.move_name }}
                        (<span id="move-pp-{{ loop.index }}">{{ move.current_pp }}</span>/{{ move.max_pp }})
                    </button>
                {% endif %}
            {% endfor %}
        </div>
    </div>
</div>

<script>
    // --- UI Navigation Functions ---
    function showMoveMenu() {
        document.getElementById('action-menu').style.display = 'none';
        document.getElementById('move-menu').style.display = 'flex';
    }

    // --- API Call Functions ---

    /**
     * Fetches the user's full team data when they click the "Pokémon" button.
     */
    async function showTeam() {
        const container = document.querySelector('.battle-container');
        const user_team_id = container.dataset.userTeamId;

        const response = await fetch(`/battle/api/team/${user_team_id}`);
        const teamData = await response.json();

        // For now, we just log the data. Later, this can show a team switch screen.
        console.log("Full Team Data:", teamData);
        alert("Check the browser's developer console (F12) to see your full team data!");
    }

async function handleMoveClick(moveSlot) {
    const dialogueBox = document.getElementById('dialogue-box');
    const container = document.querySelector('.battle-container');
    dialogueBox.innerHTML = '<p>Processing turn...</p>';

    // --- Hide the controls while the turn is processing ---
    document.getElementById('action-menu').style.display = 'none';
    document.getElementById('move-menu').style.display = 'none';

    // --- Gather all data needed for the procedure ---
    const turnData = {
        attacker_party: 'USER',
        attacker_team_id: container.dataset.userTeamId,
        attacker_member_id: container.dataset.playerMemberId,
        defender_party: 'GYM',
        defender_team_id: container.dataset.gymId,
        defender_member_id: container.dataset.opponentMemberId,
        move_slot: moveSlot,
        player_team_id: container.dataset.userTeamId,
        player_member_id: container.dataset.playerMemberId,
        opponent_team_id: container.dataset.gymId,
        opponent_member_id: container.dataset.opponentMemberId
    };

    // --- Call the Player's Turn API ---
    const response = await fetch('/battle/api/turn', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(turnData),
    });
    const result = await response.json();

    // --- Update the UI with the player's turn results ---
    if (result.success) {
        dialogueBox.innerHTML = `<p>${result.message}</p>`;

        const opponentHpElement = document.getElementById('opponent-hp');
        const opponentHpBar = document.getElementById('opponent-hp-bar');
        const opponentMaxHp = {{ state.opponent_pokemon.max_hp }};
        opponentHpElement.innerText = result.opponent_hp;
        opponentHpBar.style.width = (result.opponent_hp / opponentMaxHp * 100) + '%';
        
        // If the opponent didn't faint, trigger the AI's turn after a delay
        if (!result.message.includes('fainted')) {
            setTimeout(triggerAITurn, 2000); // Wait 2 seconds
        }
        
    } else {
        dialogueBox.innerHTML = `<p>An error occurred: ${result.message}</p>`;
    }
}

async function triggerAITurn() {
    const dialogueBox = document.getElementById('dialogue-box');
    const container = document.querySelector('.battle-container');
    dialogueBox.innerHTML = '<p>The opponent is making a move...</p>';

    // Gather the same data as before to send to the AI's brain
    const turnData = {
        player_team_id: container.dataset.userTeamId,
        player_member_id: container.dataset.playerMemberId,
        opponent_team_id: container.dataset.gymId,
        opponent_member_id: container.dataset.opponentMemberId
    };

    // Call the new AI API route
    const response = await fetch('/battle/api/ai-turn', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(turnData),
    });
    const result = await response.json();

    if (result.success) {
        dialogueBox.innerHTML = `<p>${result.message}</p>`;

        // Update the PLAYER'S HP bar this time
        const playerHpElement = document.getElementById('player-hp');
        const playerHpBar = document.getElementById('player-hp-bar');
        const playerMaxHp = {{ state.player_pokemon.max_hp }};
        playerHpElement.innerText = result.player_hp;
        playerHpBar.style.width = (result.player_hp / playerMaxHp * 100) + '%';
    } else {
        dialogueBox.innerHTML = `<p>An error occurred during AI turn: ${result.message}</p>`;
    }

    // After the AI turn, re-enable the player's controls
    document.getElementById('action-menu').style.display = 'flex';
    document.getElementById('move-menu').style.display = 'none';
    if (!result.message.includes('fainted')) {
        dialogueBox.innerHTML = `<p>What will {{ state.player_pokemon.pokemon_name }} do?</p>`;
    }
}

</script>

</body>
</html>